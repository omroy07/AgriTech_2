<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <title>Agritech Community Chat</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}" />
  <script src="https://cdn.socket.io/4.7.0/socket.io.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      transition: background 0.4s, color 0.4s;
      background: #fff;
      color: #333;
    }

    .container {
      max-width: 800px;
      margin: 40px auto;
      text-align: center;
      background: #fff;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
      position: relative;
    }

    h1 {
      margin-bottom: 20px;
    }

    input,
    select,
    button {
      margin: 8px 0;
      padding: 10px;
      font-size: 16px;
      width: 90%;
      max-width: 400px;
      border-radius: 6px;
      border: 1px solid #ccc;
    }

    button {
      cursor: pointer;
      border: none;
    }

    /* Toggle button */
    #toggleTheme {
      position: fixed;
      top: 15px;
      right: 20px;
      width: 45px;
      height: 45px;
      border-radius: 50%;
      border: none;
      cursor: pointer;
      background: #f0f0f0;
      color: #333;
      font-size: 18px;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
      transition: all 0.3s ease;
    }

    #toggleTheme:hover {
      transform: scale(1.1);
    }

    /* Back button */
    .back-button {
      display: inline-block;
      margin-top: 15px;
      padding: 8px 15px;
      background: #e0e0e0;
      border-radius: 6px;
      text-decoration: none;
      color: #333;
      font-weight: bold;
      transition: all 0.3s ease;
    }

    .back-button:hover {
      background: #bbb;
    }

    /* Chat window */
    #chatWindow {
      border: 1px solid #ccc;
      height: 300px;
      overflow-y: auto;
      margin: 10px 0;
      padding: 10px;
      text-align: left;
      background: #f9f9f9;
      border-radius: 6px;
    }

    /* Chat bubbles */
    .chat-msg {
      margin: 6px 0;
      padding: 8px 12px;
      border-radius: 15px;
      max-width: 70%;
      word-wrap: break-word;
      clear: both;
    }

    .chat-msg.self {
      background: #d4f8d4;
      margin-left: auto;
      text-align: right;
    }

    .chat-msg.other {
      background: #eaeaea;
      margin-right: auto;
      text-align: left;
    }

    /* Dark mode */
    body.dark {
      background: #121212;
      color: #eee;
    }

    body.dark .container {
      background: #1e1e1e;
      color: #eee;
    }

    body.dark #toggleTheme {
      background: #333;
      color: #ffeb3b;
    }

    body.dark .back-button {
      background: #333;
      color: #eee;
    }

    body.dark #chatWindow {
      background: #1e1e1e;
      border-color: #555;
    }

    body.dark .chat-msg.self {
      background: #388e3c;
      color: #fff;
    }

    body.dark .chat-msg.other {
      background: #444;
      color: #eee;
    }
  </style>
</head>

<body>
  <button id="toggleTheme">ðŸŒ™</button>

  <div class="container">
    <h1>Agritech Farmer Community Chat</h1>

    <!-- Login -->
    <div id="loginDiv">
      <input id="username" placeholder="Your name" />
      <select id="stateSelect">
        <option value="" disabled selected>Select your state</option>
        <option>Andhra Pradesh</option>
        <option>Arunachal Pradesh</option>
        <option>Assam</option>
        <option>Bihar</option>
        <option>Chhattisgarh</option>
        <option>Goa</option>
        <option>Gujarat</option>
        <option>Haryana</option>
        <option>Himachal Pradesh</option>
        <option>Jharkhand</option>
        <option>Karnataka</option>
        <option>Kerala</option>
        <option>Madhya Pradesh</option>
        <option>Maharashtra</option>
        <option>Manipur</option>
        <option>Meghalaya</option>
        <option>Mizoram</option>
        <option>Nagaland</option>
        <option>Odisha</option>
        <option>Punjab</option>
        <option>Rajasthan</option>
        <option>Sikkim</option>
        <option>Tamil Nadu</option>
        <option>Telangana</option>
        <option>Tripura</option>
        <option>Uttar Pradesh</option>
        <option>Uttarakhand</option>
        <option>West Bengal</option>
        <option>Delhi</option>
        <option>Puducherry</option>
        <option>Others</option>
      </select>
      <button onclick="proceedToCommunities()">Continue</button>
      <br>
      <a href="javascript:history.back()" class="back-button">â¬… Back</a>
    </div>

    <!-- Community -->
    <div id="communityDiv" style="display:none;">
      <div>
        <b>Welcome, <span id="greetName"></span>!</b>
        <br> State: <span id="greetState"></span>
      </div>
      <input id="newCommunityName" placeholder="New community name" />
      <button onclick="addCommunity()">Add Community</button>
      <ul id="communitiesList"></ul>
      <button id="quickJoinBtn" onclick="joinCommunity(selectedState)" style="margin-top:10px;">
        Join your State Group
      </button>
      <br>
      <a href="javascript:history.back()" class="back-button">â¬… Back</a>
    </div>

    <!-- Chat -->
    <div id="chatDiv" style="display:none;">
      <button onclick="leaveCommunity()">Leave Community</button>
      <button id="deleteBtn" onclick="deleteCommunity()" style="display:none;">Delete This Community</button>
      <h3 id="currentCommunity"></h3>
      <div id="chatWindow"></div>
      <input id="chatInput" placeholder="Type your message..." autocomplete="off" />
      <button onclick="sendMessage()">Send</button>
      <br>
      <a href="javascript:history.back()" class="back-button">â¬… Back</a>
      <div id="userListContainer">
        <h4>Active Farmers:</h4>
        <ul id="userList"></ul>
      </div>
    </div>
  </div>

  <script>
    let username = "";
    let selectedState = "";
    let currentCommunity = "";
    const socket = io();

    // Theme toggle
    const toggleBtn = document.getElementById('toggleTheme');
    if (localStorage.getItem("theme") === "dark") {
      document.body.classList.add("dark");
      toggleBtn.textContent = "â˜€";
    } else {
      toggleBtn.textContent = "ðŸŒ™";
    }

    toggleBtn.addEventListener('click', () => {
      document.body.classList.toggle('dark');
      if (document.body.classList.contains("dark")) {
        toggleBtn.textContent = "â˜€";
        localStorage.setItem("theme", "dark");
      } else {
        toggleBtn.textContent = "ðŸŒ™";
        localStorage.setItem("theme", "light");
      }
    });

    function proceedToCommunities() {
      username = document.getElementById('username').value.trim();
      selectedState = document.getElementById('stateSelect').value;
      if (!username) { alert("Enter your name"); return; }
      if (!selectedState) { alert("Select your state"); return; }
      document.getElementById('loginDiv').style.display = 'none';
      document.getElementById('communityDiv').style.display = 'block';
      document.getElementById('greetName').innerText = username;
      document.getElementById('greetState').innerText = selectedState;
      fetchCommunities();
    }

    function fetchCommunities() {
      fetch("/communities")
        .then(res => res.json())
        .then(communities => {
          const list = document.getElementById('communitiesList');
          list.innerHTML = "";
          communities.forEach(comm => {
            let li = document.createElement("li");
            li.textContent = comm;
            li.onclick = () => joinCommunity(comm);
            list.appendChild(li);
          });
        });
    }

    function addCommunity() {
      const room = document.getElementById('newCommunityName').value.trim();
      if (!room) return;
      fetch("/add_community", {
        method: "POST",
        headers: { 'Content-Type': "application/json" },
        body: JSON.stringify({ room })
      })
        .then(res => res.json())
        .then(() => {
          fetchCommunities();
          document.getElementById('newCommunityName').value = "";
        });
    }

    function deleteCommunity() {
      if (!currentCommunity) return;
      fetch("/delete_community", {
        method: "POST",
        headers: { 'Content-Type': "application/json" },
        body: JSON.stringify({ room: currentCommunity })
      })
        .then(res => res.json())
        .then(data => {
          alert(data.success ? "Community deleted!" : "Community not deleted. " + (data.error || ""));
          leaveCommunity();
          fetchCommunities();
        });
    }

    function joinCommunity(room) {
      if (!username) { alert("Enter your name and state first"); return; }
      if (!room) { alert("Pick a community"); return; }
      if (currentCommunity) {
        socket.emit('leave', { username, room: currentCommunity });
      }
      document.getElementById('chatWindow').innerHTML = "";
      document.getElementById('communityDiv').style.display = 'none';
      document.getElementById('chatDiv').style.display = 'block';
      document.getElementById('currentCommunity').textContent = "Community: " + room;
      currentCommunity = room;
      socket.emit('join', { username, room });
      document.getElementById('deleteBtn').style.display = "block";
    }

    function leaveCommunity() {
      if (!currentCommunity) return;
      socket.emit('leave', { username, room: currentCommunity });
      document.getElementById('chatDiv').style.display = 'none';
      document.getElementById('communityDiv').style.display = 'block';
      currentCommunity = "";
      document.getElementById('userList').innerHTML = "";
    }

    function sendMessage() {
      const msgInput = document.getElementById('chatInput');
      const msg = msgInput.value.trim();
      if (msg && currentCommunity) {
        socket.emit('message', { username, room: currentCommunity, msg });
        msgInput.value = "";
      }
    }

    socket.on('message', data => {
      const chatWindow = document.getElementById('chatWindow');
      let msgDiv = document.createElement('div');
      msgDiv.classList.add('chat-msg');
      msgDiv.classList.add(data.username === username ? 'self' : 'other');
      msgDiv.textContent = data.username + ": " + data.msg;
      chatWindow.appendChild(msgDiv);
      chatWindow.scrollTop = chatWindow.scrollHeight;
    });

    socket.on('user_list', users => {
      const userList = document.getElementById('userList');
      userList.innerHTML = '';
      users.forEach(user => {
        const li = document.createElement('li');
        li.textContent = user;
        userList.appendChild(li);
      });
    });

    window.onload = fetchCommunities;
  </script>
</body>

</html>